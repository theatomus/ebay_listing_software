# eBay Scheduled Listing (Sell API)

Modern eBay listing workflow using the Sell APIs (Inventory + Offer). Supports OAuth2, business policy validation, inventory item creation, scheduled or immediate publishing, and an optional Flask UI.

## Features
- Modern Sell API (no deprecated Trading API)
- OAuth2 (auth-code grant) and token refresh
- Inventory → Offer → Publish flow
- Scheduled or immediate listings
- Business policy+location validation
- Ngrok helper in setup for local OAuth callbacks

## Prerequisites
- Python 3.10+
- An eBay Developer account with Production Application Keys (App ID, Dev ID, Cert ID)
- Business Policies enabled (Payment, Fulfillment/Shipping, Return)
- A Merchant Location (warehouse) key
- Ngrok (for local HTTPS callback): `https://ngrok.com/download`

## Configuration
All configuration is stored in `config.json` at the project root. The first run will auto-create it with placeholders if it doesn't exist.

Edit `config.json` and replace each value:
```json
{
  "APP_ID": "YOUR_APP_ID",
  "CERT_ID": "YOUR_CERT_ID",
  "DEV_ID": "YOUR_DEV_ID",
  "USER_TOKEN": "YOUR_USER_TOKEN",
  "REDIRECT_URI": "YOUR_RUNAME",
  "EBAY_MARKETPLACE_ID": "EBAY_US",
  "PAYMENT_POLICY_ID": "YOUR_PAYMENT_POLICY_ID",
  "FULFILLMENT_POLICY_ID": "YOUR_FULFILLMENT_POLICY_ID",
  "RETURN_POLICY_ID": "YOUR_RETURN_POLICY_ID",
  "MERCHANT_LOCATION_KEY": "ShawnPrimaryWarehouse"
}
```

Where to find values:
- APP_ID / DEV_ID / CERT_ID / RuName: eBay Developer Console → Application Keys (Production)
- Business Policy IDs: Seller Hub → Account Settings → Business Policies → open each policy and copy the ID from the detail URL
- Merchant Location Key: Seller Hub → Shipping labels → Manage locations → create/edit a warehouse → copy the location key

Notes:
- `REDIRECT_URI` must be your Production RuName string (not a URL). The HTTPS callback URL (your ngrok URL + `/oauth-callback`) is set in the eBay Developer Console UI.
- Keep `EBAY_MARKETPLACE_ID` as `EBAY_US` unless you’re targeting a different marketplace.

## Running
1) Start ngrok so eBay can reach your local callback
```bash
ngrok http 80
```
Copy the HTTPS forwarding URL and set it as the “Auth accepted URL” in the eBay Developer Console (append `/oauth-callback`).

2) Run the setup and app
```bash
python setup_and_run.py
```
The setup script:
- Verifies ngrok (or gives steps to start it)
- Shows Developer Console reminders using your active ngrok URL
- Validates Business Policies and Merchant Location
- Walks you through OAuth and saves tokens

3) Create a listing
- Choose option 1 in the menu
- Enter schedule hours:
  - 0 → publish immediately
  - > 0 → scheduled start (ISO 8601, UTC, with a 30‑minute minimum buffer)

## Scheduling behavior
- Scheduling is controlled by `listingStartDate` in the Offer creation payload.
- Publish is `POST /sell/inventory/v1/offer/{offerId}/publish` and does not take scheduling params.
- If start time is too close to “now”, eBay may publish immediately; we enforce a 30‑minute buffer.

## Troubleshooting
- `invalid_request` on consent page: redirect URI mismatch. Ensure `REDIRECT_URI` in `config.json` is your RuName, and the eBay Developer Console “Auth accepted URL” matches your current ngrok HTTPS URL + `/oauth-callback`.
- `invalid_scope`: Use the minimal scopes (api_scope, sell.inventory, sell.account) and start the flow from a fresh URL generated by the CLI.
- Ngrok `ERR_NGROK_8012` / 502: Nothing listening on the tunneled port. For the CLI flow, you can ignore the page and paste the full redirect URL back into the terminal; or run a local server on the same port ngrok is tunneling.
- Offer publish errors: verify Business Policy IDs and Merchant Location are correct; ensure `listingStartDate` is in the future (UTC); use a public HTTPS image URL.

## Project Structure (high-level)
- `config.json` – credentials and policy IDs (placeholders by default)
- `config.py` – loads `config.json` and provides `eBayConfig`
- `setup_and_run.py` – ngrok helper, config validation, OAuth kickoff, app runner
- `main_sell_api.py` – interactive CLI for creating scheduled/immediate listings
- `sell_api_client.py` – Sell API client (inventory/offer/publish)
- `lister/` – optional Flask UI (auth flow and basic pages)

## License
This project is licensed under the Apache License 2.0. See `LICENSE` for details.
